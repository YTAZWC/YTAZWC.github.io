---
title: 乐观锁和悲观锁
date: 2024/7/30
author: 花木凋零成兰
---

# 乐观锁和悲观锁

## 悲观锁

悲观锁总是假设**最坏**的情况, 认为共享资源每次被访问时都会出现问题(比如共享资源被修改), 所以需要在每次获取资源操作时上锁, 如此避免其他线程的访问, 其他线程想拿到该资源时会被阻塞, 直到锁被释放;

即, **共享资源每次只有一个线程使用, 其他线程阻塞, 使用结束后再被其他线程访问**;

在 Java 中 `synchronized` 和 `ReentrantLock`(可重入锁) 等独占锁就是悲观锁思想的体现;

**缺点:**
- 高并发的场景下, 激烈地锁竞争容易造成线程阻塞, 同时大量阻塞线程会导致系统的上下文切换频繁, 增加性能开销;
- 线程获取锁的顺序不当时, 可能会造成死锁问题;

## 乐观锁

乐观锁则总是假设**最好**的情况, 认为共享资源每次被访问的时候不会出现问题, 线程可以不停地执行, 不需要加锁或等待, 只有在提交修改时对资源进行验证, 即判断是否被其他线程修改;

乐观锁一般会使用版本号机制或 CAS 算法实现, CAS算法居多;

在 Java 中 `java.util.concurrent.atomic` 包下的原子变量类就是使用乐观锁的一种实现方式 CAS 实现的; 且 `LongAdder` 在高并发的情况下会比 `AtomicInteger` 和 `AtomicLong` 性能更好, 代价是消耗更多的内存空间;

**优点:**
- 高并发场景下, 乐观锁相对悲观锁而言, 不存在锁竞争造成线程阻塞, 也不会有死锁问题; 性能上往往更好;

**缺点:**
- 冲突频繁发生, 即写操作占比更多, 会导致频繁失败重试, 此时对性能影响较大, CPU飙升; 可以采用空间换空间的方式解决该问题, 如`LongAdder`;

### 版本号机制

> 一般是在数据表中添加 数据版本号`version`字段, 表示数据被修改次数;

当数据被修改时, `version`会加一; 如线程A更新数据值时, 在读取数据的同时也会读取 `version`的值, 提交更新时, 若刚读取到的 `version` 值等于当前数据库中的 `version` 值时才会更新; 否则重试更新操作, 直到更新成功;

**示例：** 假设银行账号信息表中有一个 version 字段, 值为1, 且账户余额 `balance` 值为 $500;
1. 线程A此时读取数据(version = 1), 并扣除余额 $50(此时 balance = 450);
2. 在线程A执行的过程中, 线程B 也读取了数据(version = 1), 并扣除余额 $20(此时 balance = 480);
3. 线程A 执行更新操作后, 提交数据(version=1, balance=450)更新, 此时提交数据版本(version=1)等于数据库中记录的当前版本(version=1); 数据成功更新, 且数据记录版本version值为2;
4. 当线程B完成数据更新操作后, 提交更新时(version=1, balance=480), 此时数据库中数据记录版本为 **2**, 则不满足"提交版本必须等于当前版本才能更新"的乐观锁策略, 因此,线程B的提交被驳回;

如此, 则避免了线程B基于`version=1`的旧版本数据修改的结果覆盖线程A的操作结果的可能;

### CAS算法

> CAS 全称是 Compare And Swap(比较和交换), 用于实现乐观锁, 被广泛应用于各大框架中;

CAS 的思想就是: 用一个预期值和要更新的变量值进行比较, 两值相等才会进行更新;

CAS 是一个原子操作, 底层依赖于一条 CPU 的原子指令;

CAS 涉及三个操作数:
- V: 要更新的变量值(Var);
- E: 预期值(Excepted);
- N: 拟写入的新值(New);

即当且仅当 $V = E$ 时, CAS 通过原子方式用 新值N 来更新V的值; 如果不等, 则说明已经有其他线程更新了 V, 当前线程放弃更新;

**示例：**


## 总结
悲观锁多用于写比较多的情况 (多写场景,竞争激烈), 可以避免频繁失败和重试影响性能; 因为悲观锁开销是固定的; 如果乐观锁解决了频繁重试(使用 LongAdder)的问题, 也可以考虑使用乐观锁;

乐观锁多用于写比较少的情况 (多读场景,竞争较少), 可以避免频繁加锁影响性能; 但是,乐观锁主要针对的对象是单个共享变量;

## 参考文章

- [乐观锁和悲观锁详解](https://javaguide.cn/java/concurrent/optimistic-lock-and-pessimistic-lock.html)
- 
